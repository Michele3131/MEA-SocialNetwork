<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilo di {{ user.Nickname }} - MEA SOCIETAS SOCIALIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="lightbox">
        <span class="lightbox-close">&times;</span>
        <div class="lightbox-content-wrapper"></div>
    </div>

    <div class="modal fade" id="modalNewPost" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-theme bg-panel">
                <div class="modal-header border-bottom-theme">
                    <h5 class="modal-title terminal-header m-0">> NUOVO_POST</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/post" method="POST" enctype="multipart/form-data" id="form-new-post">
                        <div class="mb-3">
                            <label for="post-description" class="form-label text-secondary">> TESTO</label>
                            <textarea class="form-control bg-dark text-white border-theme" id="post-description" name="description" rows="3" placeholder="Cosa stai pensando?"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="post-image" class="form-label text-secondary">> FOTO (Opzionale)</label>
                            <input class="form-control bg-dark text-white border-theme" type="file" id="post-image" name="image" accept="image/*">
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-terminal">PUBBLICA</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% if is_self %}
    <div class="modal fade" id="modalSettings" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-theme bg-panel">
                <div class="modal-header border-bottom-theme">
                    <h5 class="modal-title terminal-header m-0">> IMPOSTAZIONI</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column gap-3">
                    <form method="POST" action="/settings/delete-my-posts" class="d-flex justify-content-between align-items-center gap-3">
                        <div class="text-secondary" style="font-size: 0.85rem;">> ELIMINA_TUTTI_I_POST</div>
                        <button type="submit" class="btn btn-terminal">ESEGUI</button>
                    </form>

                    <form method="POST" action="/settings/delete-profile" class="d-flex flex-column gap-2">
                        <div class="text-secondary" style="font-size: 0.85rem;">> ELIMINA_PROFILO</div>
                        <input class="form-control bg-dark text-white border-theme" name="confirm_phrase" placeholder='Scrivi "mea societas socialis" e invia'>
                        <div class="text-end">
                            <button type="submit" class="btn btn-terminal">ELIMINA</button>
                        </div>
                    </form>

                    {% if is_admin %}
                    <div class="border-top-theme pt-3 d-flex flex-column gap-3">
                        <form method="POST" action="/admin/delete-all-posts" class="d-flex justify-content-between align-items-center gap-3">
                            <div class="text-secondary" style="font-size: 0.85rem;">> ELIMINA_TUTTI_I_POST (ADMIN)</div>
                            <button type="submit" class="btn btn-terminal">ESEGUI</button>
                        </form>
                        <form method="POST" action="/admin/delete-all-users" class="d-flex justify-content-between align-items-center gap-3">
                            <div class="text-secondary" style="font-size: 0.85rem;">> ELIMINA_TUTTI_GLI_UTENTI (ADMIN)</div>
                            <button type="submit" class="btn btn-terminal">ESEGUI</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="d-flex align-items-center justify-content-center vh-100">
        <div class="app-wrapper">
            <div class="row h-100 m-0">
                <div class="col-md-8 left-panel p-0 pe-md-3 h-100">
                    <div class="panel-content border-theme p-3 h-100 d-flex flex-column">
                        <div class="profile-header-container mb-4">
                            <div class="terminal-header mb-3">
                                <span>> USER_PROFILE: {{ user.Nickname }}</span>
                                <div style="display:flex; align-items:center; gap: 8px;">
                                    <a href="/" class="btn-icon no-rotate" style="text-decoration: none; line-height: 0;" title="Home">
                                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1z"></path>
                                        </svg>
                                    </a>
                                    {% if is_self %}
                                    <button class="btn-icon no-rotate" type="button" title="Impostazioni" data-bs-toggle="modal" data-bs-target="#modalSettings" style="line-height: 0;">
                                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"></path>
                                            <path d="M19.4 15a7.8 7.8 0 0 0 .1-6l2-1.2-2-3.5-2.3.7a8 8 0 0 0-5.2-3L11.7 0H8.3L8 1.8a8 8 0 0 0-5.2 3l-2.3-.7-2 3.5L.5 9a7.8 7.8 0 0 0 .1 6L0.5 16.2l2 3.5 2.3-.7a8 8 0 0 0 5.2 3l.3 1.8h3.4l.3-1.8a8 8 0 0 0 5.2-3l2.3.7 2-3.5L19.4 15z"></path>
                                        </svg>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="d-flex align-items-start gap-4">
                                <div class="profile-avatar-wrapper">
                                    <img src="{{ user.Avatar or 'https://api.dicebear.com/7.x/pixel-art/svg?seed=' + user.Nickname }}" alt="Avatar" class="profile-avatar-large border-theme">
                                </div>
                                <div class="profile-info-details flex-grow-1">
                                    <div class="d-flex align-items-center gap-3 mb-2">
                                        <h2 class="m-0" style="color: var(--text-primary); font-family: 'Fira Code', monospace;">@{{ user.Nickname }}</h2>
                                        <span class="badge-terminal">ISCRITTO: {{ user.created_at or '01/01/2026' }}</span>
                                    </div>
                                    <div class="profile-stats mt-3">
                                        <div class="stat-item">
                                            <span class="stat-label">TOTALE PAPARELL:</span>
                                            <span class="stat-value" id="total-paparell">{{ total_score }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="terminal-header mb-2">
                            <span>> POST_PUBBLICATI</span>
                        </div>

                        <div class="feed-container overflow-auto flex-grow-1" id="profile-posts-container">
                            {% for post in posts %}
                                {% set desc = post.Description or '' %}
                                {% set has_media = post.Content %}
                                {% set has_text = desc|trim|length > 0 %}
                                {% set post_class = 'post-standard' %}
                                {% if has_media and not has_text %}
                                    {% set post_class = 'post-media-only' %}
                                {% elif (not has_media) and has_text %}
                                    {% set post_class = 'post-text-only' %}
                                {% endif %}

                                <div class="terminal-card {{ post_class }}" data-post-id="{{ post.id }}" data-description='{{ desc|tojson }}'>
                                    {% if post_class == 'post-media-only' %}
                                        <div class="media-only-layout">
                                            <div class="media-only-media" onclick="openLightboxMedia('{{ post.Content }}', 'image')">
                                                <img src="{{ post.Content }}" alt="Post media">
                                            </div>
                                            <div class="media-only-info">
                                                <div class="media-only-meta">
                                                    <div class="media-only-date">[{{ post.created_at }}]</div>
                                                    <div class="media-only-user" onclick="window.location.href='{{ url_for('profile', username=user.Nickname) }}'" style="cursor:pointer;">@{{ user.Nickname }}</div>
                                                </div>
                                                <div class="media-only-bottom">
                                                    <div class="media-only-score">PAPARELL: <span class="score-value" data-id="{{ post.id }}">{{ post.likes or 0 }}</span></div>
                                                    <div class="media-only-buttons">
                                                        <button class="btn-score btn-plus {% if post.user_vote == 1 %}active{% endif %}" data-id="{{ post.id }}" data-vote="1">+</button>
                                                        <button class="btn-score btn-minus {% if post.user_vote == -1 %}active{% endif %}" data-id="{{ post.id }}" data-vote="-1">-</button>
                                                    </div>
                                                    <div style="padding: 0 8px 8px 8px; display: flex; justify-content: flex-end;">
                                                        {% if post.can_edit or post.can_delete %}
                                                            <button class="btn-icon no-rotate post-actions" type="button" data-id="{{ post.id }}" data-can-edit="{{ 1 if post.can_edit else 0 }}" data-can-delete="{{ 1 if post.can_delete else 0 }}" title="Azioni">⋮</button>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="post-layout">
                                            {% if has_media %}
                                                <div class="post-media-section">
                                                    <div class="media-container" onclick="openLightboxMedia('{{ post.Content }}', 'image')">
                                                        <img src="{{ post.Content }}" alt="Post media">
                                                    </div>
                                                </div>
                                                <div class="post-divider"></div>
                                            {% endif %}

                                            <div class="post-content-section">
                                                <div class="post-header">
                                                    <span class="user" style="cursor: pointer;" onclick="window.location.href='{{ url_for('profile', username=user.Nickname) }}'">@{{ user.Nickname }}</span>
                                                    <div class="header-right">
                                                        <span class="time">[{{ post.created_at }}]</span>
                                                        <span class="score">PAPARELL: <span class="score-value" data-id="{{ post.id }}">{{ post.likes or 0 }}</span></span>
                                                        {% if post.can_edit or post.can_delete %}
                                                            <button class="btn-icon no-rotate post-actions" type="button" data-id="{{ post.id }}" data-can-edit="{{ 1 if post.can_edit else 0 }}" data-can-delete="{{ 1 if post.can_delete else 0 }}" title="Azioni">⋮</button>
                                                        {% endif %}
                                                    </div>
                                                </div>

                                                {% if has_text %}
                                                    {% set should_truncate = desc|length > 220 %}
                                                    <div class="post-caption {% if not should_truncate %}expanded{% endif %}" data-post-id="{{ post.id }}">
                                                        <div class="post-caption-text">{{ desc|e|replace('\n', '<br>')|safe }}</div>
                                                        {% if should_truncate %}
                                                            <button class="caption-toggle" type="button" data-post-id="{{ post.id }}">…</button>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            </div>

                                            <div class="post-side-controls">
                                                <div class="controls-stack">
                                                    <button class="btn-score btn-plus {% if post.user_vote == 1 %}active{% endif %}" data-id="{{ post.id }}" data-vote="1">+</button>
                                                    <button class="btn-score btn-minus {% if post.user_vote == -1 %}active{% endif %}" data-id="{{ post.id }}" data-vote="-1">-</button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            {% else %}
                            <div class="text-center p-5 text-secondary" style="grid-column: 1 / -1;">
                                <span class="blink">> NESSUN POST PUBBLICATO</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="col-md-4 right-panel d-flex flex-column p-0 h-100">
                    <div class="controls-panel border-theme p-2 mb-3">
                        <div class="controls-grid">
                            <button class="btn-control" id="btn-theme" title="Cambia Tema"></button>
                            <button class="btn-control" id="btn-new-post-trigger" title="Nuovo Post" data-bs-toggle="modal" data-bs-target="#modalNewPost">
                                <svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:3;"><path d="M12 5v14m-7-7h14"></path></svg>
                            </button>
                            {% set profile_url = url_for('profile', username=viewer.Nickname) if viewer else url_for('access') %}
                            <div class="btn-control" id="profile-display" style="cursor: pointer; display: flex; flex-direction: row; gap: 10px; align-items: center; justify-content: center; white-space: nowrap;" onclick="window.location.href='{{ profile_url }}'">
                                <span id="user-tag" style="font-weight: bold;">@{{ viewer.Nickname if viewer else 'guest' }}</span>
                                <span style="font-size: 0.9rem; color: var(--text-secondary); border-left: 1px solid var(--border-color); padding-left: 10px;">
                                    <span id="user-balance">100</span> P
                                </span>
                            </div>
                            <div id="search-container" class="btn-control" style="padding:0; border:none;">
                                 <button class="btn-control" id="btn-search" style="width:100%; height:100%; border:1px solid var(--border-color);">CERCA</button>
                            </div>
                        </div>
                    </div>

                    <div class="notification-panel border-theme p-3 mb-3 h-35" style="overflow-y: auto;">
                        <h4 class="terminal-header">> NOTIFICHE</h4>
                        <ul class="list-unstyled terminal-list" id="notification-list">
                            <li class="p-2 border-bottom-theme text-secondary">Nessuna nuova notifica.</li>
                        </ul>
                    </div>

                    <div class="trending-panel border-theme d-flex flex-column flex-grow-1" style="min-height: 0;">
                        <div class="trending-content p-3 flex-grow-1" style="overflow-y: auto;">
                            <div class="terminal-header">
                                <span>> TENDENZE</span>
                            </div>
                            <div class="trending-list" id="trending-list"></div>
                        </div>
                        <div class="trending-buttons border-top-theme d-flex" style="height: 40px; min-height: 40px;">
                            <button class="btn btn-terminal w-50 h-100 active" id="btn-all-time">SEMPRE</button>
                            <button class="btn btn-terminal w-50 h-100" id="btn-last-24h">ULTIME 24H</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
